<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.schedule.app.repository.ScheduleSearchMapper">

    <!-- readDefaultScheduleRecord -->
    <resultMap id="DefaultScheduleMap" type="com.schedule.app.record.output.item.DefaultScheduleRecord">
        <id property="scheduleId" column="id"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="from" column="start_date"/>
        <result property="to" column="end_date"/>
        <result property="worktypeName" column="work_type_name"/>
        <result property="worktypeColor" column="work_type_color"/>
    </resultMap>

    <resultMap id="UserDefaultScheduleRecordMap" type="com.schedule.app.record.output.UserDefaultScheduleRecord">
        <collection property="defaultSchedules"
                    ofType="com.schedule.app.record.output.item.DefaultScheduleRecord"
                    resultMap="DefaultScheduleMap"/>
    </resultMap>

    <select id="readDefaultScheduleRecord" resultMap="UserDefaultScheduleRecordMap">
        SELECT
            ds.id,
            ds.start_time,
            ds.end_time,
            ds.start_date,
            ds.end_date,
            st.work_type_name,
            st.work_type_color
        FROM
            users AS u
        LEFT JOIN
            default_schedule AS ds ON ds.user_id = u.user_id
            <if test="from != null">
                AND ds.end_date &gt;= #{from}
            </if>
            <if test="to != null">
                AND ds.start_date &lt;= #{to}
            </if>
        JOIN
            schedule_type AS st ON ds.work_type_id = st.id
        JOIN
            organization AS o ON u.organization_code = o.organization_code
        <where>
            <if test="userId != null and userId != ''">
                AND u.user_id = #{userId}
            </if>
            <if test="names != null">
                <foreach collection="names" item="name" open="AND (" separator="AND" close=")">
                    u.name LIKE CONCAT('%', #{name}, '%')
                </foreach>
            </if>
        </where>
    </select>

    <!-- readRegularScheduleRecord -->
    <resultMap id="RegularScheduleMap" type="com.schedule.app.record.output.item.RegularScheduleRecord">
        <id property="scheduleId" column="id"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="from" column="start_date"/>
        <result property="to" column="end_date"/>
        <result property="daysOfWeeks" column="days_of_week"/>
        <result property="intervalWeeks" column="interval_weeks"/>
        <result property="worktypeName" column="work_type_name"/>
        <result property="worktypeColor" column="work_type_color"/>
    </resultMap>

    <resultMap id="UserRegularScheduleRecordMap" type="com.schedule.app.record.output.UserRegularScheduleRecord">
        <collection property="regularSchedules"
                    ofType="com.schedule.app.record.output.item.RegularScheduleRecord"
                    resultMap="RegularScheduleMap"/>
    </resultMap>

    <select id="readRegularScheduleRecord" resultMap="UserRegularScheduleRecordMap">
        SELECT
            rs.id,
            rs.start_time,
            rs.end_time,
            rs.start_date,
            rs.end_date,
            rs.days_of_week,
            rs.interval_weeks,
            st.work_type_name,
            st.work_type_color
        FROM
            users AS u
        LEFT JOIN
            regular_schedule AS rs ON rs.user_id = u.user_id
            <if test="from != null">
                AND rs.end_date &gt;= #{from}
            </if>
            <if test="to != null">
                AND rs.start_date &lt;= #{to}
            </if>
        JOIN
            schedule_type AS st ON rs.work_type_id = st.id
        JOIN
            organization AS o ON u.organization_code = o.organization_code
        <where>
            <if test="userId != null and userId != ''">
                AND u.user_id = #{userId}
            </if>
            <if test="names != null">
                <foreach collection="names" item="name" open="AND (" separator="AND" close=")">
                    u.name LIKE CONCAT('%', #{name}, '%')
                </foreach>
            </if>
            <if test="organizationCode != null and organizationCode != ''">
                AND o.organization_code = #{organizationCode}
            </if>
        </where>
    </select>

    <!-- readIrregularScheduleRecord -->
    <resultMap id="IrregularScheduleMap" type="com.schedule.app.record.output.item.IrregularScheduleRecord">
        <id property="scheduleId" column="id"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="date" column="date"/>
        <result property="worktypeName" column="work_type_name"/>
        <result property="worktypeColor" column="work_type_color"/>
    </resultMap>

    <resultMap id="UserIrregularScheduleRecordMap" type="com.schedule.app.record.output.UserIrregularScheduleRecord">
        <collection property="irregularSchedules"
                    ofType="com.schedule.app.record.output.item.IrregularScheduleRecord"
                    resultMap="IrregularScheduleMap"/>
    </resultMap>

    <select id="readIrregularScheduleRecord" resultMap="UserIrregularScheduleRecordMap">
        SELECT
            irs.id,
            irs.start_time,
            irs.end_time,
            irs.date,
            st.work_type_name,
            st.work_type_color
        FROM
            users AS u
        LEFT JOIN
            irregular_schedule AS irs ON irs.user_id = u.user_id
            <if test="from != null">
                AND irs.date &gt;= #{from}
            </if>
            <if test="to != null">
                AND irs.date &lt;= #{to}
            </if>
        JOIN
            schedule_type AS st ON irs.work_type_id = st.id
        JOIN
            organization AS o ON u.organization_code = o.organization_code
        <where>
            <if test="userId != null and userId != ''">
                AND u.user_id = #{userId}
            </if>
            <if test="names != null">
                <foreach collection="names" item="name" open="AND (" separator="AND" close=")">
                    u.name LIKE CONCAT('%', #{name}, '%')
                </foreach>
            </if>
            <if test="organizationCode != null and organizationCode != ''">
                AND o.organization_code = #{organizationCode}
            </if>
        </where>
    </select>
</mapper>